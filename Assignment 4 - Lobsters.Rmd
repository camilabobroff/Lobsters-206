---
title: "Assignment 4, Lobster"
author: "Lydia Bleifuss & Camila Bobroff"
date: "11/14/2018"
output:
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(tidyverse)
library(pwr)
library(knitr)
library(plotly)
library(extrafont)
library(ggrepel)
library(kableExtra)
library(effsize)
library(dplyr)
library(vcdExtra)
library(car)
library(ggpubr)
library(ggplot2)
library(ggsignif)
library(xtable)
```

```{r, include = FALSE}
lob_size_abun <- read_csv("lobster_size_abundance.csv")
lob_trap <- read_csv("lobster_traps.csv")
```

Part 1. Lobster abundance and fishing pressure (2012 - 2017)

```{r, echo = FALSE, message = FALSE}
#Producing mean abundance by year
abun_year <- lob_size_abun %>%
  group_by(YEAR, SITE) %>% 
  filter(COUNT != "0") %>% 
  summarize(
    sum_abun = round(sum(COUNT), digits = 2)
  ) %>% 
  rename(Site = SITE)
#Producing mean trap count by year

trap_year <- lob_trap %>% 
  filter( SITE != "AHND", SITE != "ABUR", SITE != "GOLB", SITE != "AHND to AQUE") %>% 
  group_by(YEAR, SITE) %>%
  summarize(
    sum_trap = round(sum(TRAPS), digits = 2)
  ) %>% 
  rename(Site = SITE)

#Join the data sets together so they pull the same year and corresponding data 

abun_trap <- full_join(abun_year, trap_year) %>% 
  select(YEAR, Site, sum_abun, sum_trap)
```

```{r, echo = FALSE, message = FALSE}
#Creating Scatter-plots for question 1. 

#Abundance Totals 
abun_point <- ggplot(abun_trap, (aes(x = YEAR,
      y = sum_abun,label = ""))) +
  geom_point(aes(color = Site)) +
  theme_classic() +
  scale_size(range = c(0,9)) +
  geom_line(aes(color = Site), size = 0.5) +
   scale_y_continuous(expand = c(0,0), limits = c(0,800)) +
  labs(x = "Year", y = "Total Spiny Lobster Abundance") +
  theme(text = element_text(family = "Times New Roman"))+
  scale_colour_discrete(name="Site",
                         breaks=c("AQUE", "CARP", "IVEE", "MOHK", "NAPL"),
                         labels=c("Arroyo Quemado", "Carpinteria", "Isla Vista", "Mohawk Reef", "Naples Reef")) #Change legend labels

abun_point
```

**Figure 1. Lobster Abundance in the Santa Barbara Channel (2012 - 2017).**  
Counts of California spiny lobster collected annually in late summer before the fishing season (data collected by SBC LTER)^3^.
```{r echo = FALSE, message = FALSE}
#Trap Totals
trap_point <- ggplot(abun_trap, (aes(x = YEAR,
      y = sum_trap,label = ""))) +
  geom_point(aes(color = Site))+
  theme_classic() +
  scale_size(range = c(0,9)) +
  geom_line(aes(color = Site), size = 0.5) +
  scale_y_continuous(expand = c(0,0), limits = c(0,1300)) +
  labs(x = "Year", y = "Site Trap Totals") +
  theme(text = element_text(family = "Times New Roman")) +
  scale_colour_discrete(name="Site",
                         breaks=c("AQUE", "CARP", "IVEE", "MOHK", "NAPL"),
                         labels=c("Arroyo Quemado", "Carpinteria", "Isla Vista", "Mohawk Reef", "Naples Reef")) #Change legend labels

trap_point
```

**Figure 2. Lobster Traps in the Santa Barbara Channel (2012 - 2017).**  
Counts of commercial trap floats collected every two to four weeks during the fishing season (data collected by SBC LTER)^3^.

Part 2. Compare mean lobster size by site in 2017.

```{r, echo = FALSE, message = FALSE}

#Step 1: Get data into case/tidy format

count <- as.data.frame(lob_size_abun) #Coerce to data.frame so we can use expand.dft()
lob_size_tidy <- expand.dft(count, freq = "COUNT")#Expand data so it is in tidy format

lob_size_tidy2017 <- lob_size_tidy %>% 
  filter(YEAR == 2017) %>%  #Keep observations only from 2017
  mutate(
    mean_size2017 = mean(SIZE),
    sd_size = sd(SIZE),
    sample_size = length(SITE)
  )

#Step 2: Calculate mean lobster sizes (carapace length (mm)) across the five sites for observations in 2017

lob_size_summary <- lob_size_tidy2017 %>% 
  group_by(SITE) %>% 
  summarize(
    mean_size2017 = round(mean(SIZE),2),
    sd_size = round(sd(SIZE),2),
    sample_size = length(SITE)
  )
#Step 3: Test assumptions, exploratory graphs, summary statistics, Levene's test for equal variances

lobster_hists <- ggplot(lob_size_tidy2017, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE)) + 
  facet_wrap(~ SITE)

lobster_qqplot <- ggplot(lob_size_tidy2017, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)
#Data seem to be normally distributed based on our histograms and qqplots!

# Levene's test for equal variances (> 2 groups)

# H0: Variances are equal
# HA: Variances are unequal

lobster_levene <- leveneTest(SIZE ~ SITE, data = lob_size_tidy2017)
# We reject the null hypothesis of equal variances (p < 0.001)...

variances <- lob_size_tidy2017 %>% 
  group_by(SITE) %>% 
  summarize(
    variance = var(SIZE)
  )
# Because the largest variance is less than 4 times greater than the smallest variances, we can use an ANOVA to compare means.

#Step 4: One-way ANOVA
#Single factor: SITE | Number of levels: 5 (AQUE, CARP, IVEE, MOHK, NAPL) | Random variable: SIZE (carapace length (mm))

#QUESTION: Is there a significant difference in mean carapace length (mm) in AQUE, CARP, IVEE, MOHK, and NAPL?

# H0: Mean lobster carapace length across all sites are equal 
# HA: At LEAST two means differ significantly

lobster_aov <- aov(SIZE ~ SITE, data = lob_size_tidy2017)
# At least two samples were taken from populations with different means (P = .009). Which ones are different?

#Step 5: Post-hoc test (Tukey's HSD)

lobster_ph <- TukeyHSD(lobster_aov)
```

```{r, r ANOVA_table, echo = FALSE, results = 'asis', message = FALSE}
#Step 6: Create table and column graph with error bars indicating ±1 standard deviation

lob_boxplot <- ggplot(lob_size_tidy2017, aes(x = SITE, y = SIZE))+
  geom_boxplot(aes(fill = SITE, colour = SITE), alpha = 0.5, show.legend = FALSE)+
  labs(title="Lobster Sizes by Location in 2017", 
                    x ="Location",
                    y = "Carapace Length (mm)")+
  theme_classic()+
  theme(legend.position = "none")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  stat_compare_means(method = "anova", label.y = 170)+ # Add global p-value
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "0.5")+ # Pairwise comparison against
    scale_x_discrete(labels=c("AQUE" = "Arroyo Quemado",
                   "CARP" = "Carpinteria",
                   "IVEE" = "Isla Vista",
                   "MOHK" = "Mohawk Reef",
                   "NAPL" = "Naples Reef"))
lob_boxplot

lob_size_graph <- lob_size_summary %>% 
   ggplot(aes(x = SITE, y = mean_size2017)) +
   geom_col(fill = "tomato3", colour = "black", aes(fill = SITE), position = "dodge", show.legend = FALSE) +
  labs(y = "Mean Lobster Carapace Length (mm)", x = "Site")+
  geom_signif(comparisons = list(c("NAPL", "CARP")), annotations = "p = 0.023", y_position = 95, tip_length = 0.1, size = 0.5, textsize = 3)+
   theme_classic()+
  geom_signif(comparisons = list(c("NAPL", "IVEE")), annotations = "p = 0.004", y_position = 110, tip_length = 0.1, size = 0.5, textsize = 3)+
  scale_y_continuous(expand = c(0,0), limits=c(0,130))+
  scale_y_continuous(expand = c(0,0), limits=c(0,130))+
  geom_errorbar(aes(ymin=mean_size2017-sd_size, ymax=mean_size2017+sd_size), width=.2)+
  scale_x_discrete(labels=c("AQUE" = "Arroyo Quemado",
                   "CARP" = "Carpinteria",
                   "IVEE" = "Isla Vista",
                   "MOHK" = "Mohawk Reef",
                   "NAPL" = "Naples Reef"))
lob_size_graph

lob_table2017 <- lob_size_summary %>% 
    mutate(Site=
    case_when(
      SITE == "NAPL" ~ "Naples Reef",
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "CARP" ~ "Carpinteria"
    )) %>% 
  select(Site, mean_size2017, sd_size, sample_size) %>% 
  kable(col.names = c("Site", "Mean Carapace Length (mm)", "Standard Deviation (mm)", "Sample Size"), align = "c") %>% 
  kable_styling(bootstrap_options = c("striped"))
  
lob_table2017
```
**Table 1. Mean lobster size summary by site (2017).**  

**Table 2. Mean lobster size ANOVA results (2017).**

**Figure 3. Mean Lobster Size in the Santa Barbara Channel (2017)**  
2017 mean lobster carapace length (mm) by site, measured in late summer before the fishing season. Error bars indicate ± 1 standard deviation. Brackets indicate *p*-values for significantly different means as determined by one-way ANOVA (F(4, 1663) = 3.4, *p* = 0.009, $\alpha$ = 0.05) with post-hoc Tukey's HSD ($\alpha$ = 0.05). Data source: SBC LTER)^3^.

In 2017, mean lobster carapace length differ significantly between Naples Reef and Carpinteria and between Naples Reef and Isla Vista (F(df) = statistic, P = 0.02 & 0.004 respectively, $\alpha$ = 0.05 with post-hoc Tukey's HSD, $\alpha$ = 0.05.)

Part 3. Changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)

```{r, echo = FALSE, message = FALSE}
#Step 1: Calculate mean size at each site for 2012 and 2017. Data exploration.

graph_size_change <- lob_size_tidy %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>%
  group_by(YEAR) %>% 
  select(YEAR, SITE, SIZE) %>% 
  ggplot(aes(x = SITE, y = SIZE, group = YEAR))+
    geom_col(position = 'dodge', aes(fill = YEAR))+
  theme(legend.position = c(2012, 2017))+
  theme_classic()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  scale_y_continuous(expand = c(0,0), limits=c(0,130))+
  scale_y_continuous(expand = c(0,0), limits=c(0,130))+
  scale_x_discrete(labels=c("AQUE" = "Arroyo Quemado",
                   "CARP" = "Carpinteria",
                   "IVEE" = "Isla Vista",
                   "MOHK" = "Mohawk Reef",
                   "NAPL" = "Naples Reef"))
graph_size_change

lob_size_IVEE <- lob_size_tidy %>% 
  filter(SITE == "IVEE") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

IVEE_summary <- lob_size_IVEE %>% 
  summarize(
    mean_size = mean(SIZE),
    sample_size = length(SIZE), #Sample sizes are VERY different, only 26 observations for IVEE in 2012
    sd_size = sd(SIZE)
  )

lob_size_NAPL <- lob_size_tidy %>% 
  filter(SITE == "NAPL") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

NAPL_summary <- lob_size_NAPL %>% 
  summarize(
    mean_size = mean(SIZE),
    sample_size = length(SIZE) #Sample sizes are very different again, only 6 observations in 2012 for NAPL! Might be something to mention in the write up..
  )

lob_size_AQUE <- lob_size_tidy %>% 
  filter(SITE == "AQUE") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

AQUE_summary <- lob_size_AQUE %>% 
  summarize(
    mean_size = mean(SIZE),
    sample_size = length(SIZE)
  )

lob_size_MOHK <- lob_size_tidy %>% 
  filter(SITE == "MOHK") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

MOHK_summary <- lob_size_MOHK %>% 
  summarize(
    mean_size = mean(SIZE),
    sample_size = length(SIZE),
    sd_size = sd(SIZE)
  )

lob_size_CARP <- lob_size_tidy %>% 
  filter(SITE == "CARP") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

CARP_summary <- lob_size_CARP %>% 
  summarize(
    mean_size = mean(SIZE),
    sample_size = length(SIZE)
  )

#Step 2: Test assumptions (each site for 2012 and 2017)
hists2017 <- ggplot(lob_size_tidy2017, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE))+
  facet_wrap(~SITE)

qqplots2017 <- ggplot(lob_size_tidy2017, aes(sample = SIZE)) +
  geom_qq()+
  facet_wrap(~SITE)
#Based on our histograms and qqplots, our 2017 data for each site looks normal

lob_size_tidy2012 <- lob_size_tidy %>%
  filter(YEAR == "2012")

hists2012 <- ggplot(lob_size_tidy2012, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE))+
  facet_wrap(~SITE)

qqplots2012 <- ggplot(lob_size_tidy2012, aes(sample = SIZE)) +
  geom_qq()+
  facet_wrap(~SITE)
#Based on our histograms and qqplots, our 2012 data for each site look normal enough... IVEE is the farthest from normal, with only 6 observations. Might be worth noting in the write-up.

# F-test for equal variances
# H0: Variances are equal (ratio of variances = 1)
# HA: Variances are not equal (ratio of variances is NOT = 1)

IVEE_ftest <- lob_size_IVEE %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

IVEE_ftest # Retain the null hypothesis of equal variances (p-value = 0.30)
# We can override the default setting in t.test() function of var.equal = FALSE

NAPL_ftest <- lob_size_NAPL %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.76)
# We can override the default setting in t.test() function of var.equal = FALSE

AQUE_ftest <- lob_size_AQUE %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.30)
# We can override the default setting in t.test() function of var.equal = FALSE

MOHK_ftest <- lob_size_MOHK %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.15)
# We can override the default setting in t.test() function of var.equal = FALSE

CARP_ftest <- lob_size_CARP %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.20)
# We can override the default setting in t.test() function of var.equal = FALSE

#Step 3: One sided, two sample t-test to compare lobster size at MPA sites (IVEE and NAPL)

#HO: Lobsters are NOT significantly larger in 2017 than in 2012
#HA: Lobsters are significantly larger in 2017 than in 2012

IVEE_ttest <- lob_size_IVEE %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, alternative = "less", data = ., conf.level = 0.975)
#P=0.03, reject the null

#Power analysis
IVEE_2012 <- lob_size_IVEE %>% 
 filter(YEAR == "2012") %>% 
 pull(SIZE)
 
IVEE_2017 <- lob_size_IVEE %>% 
 filter(YEAR == "2017") %>% 
 pull(SIZE)

IVEE_effsize <- cohen.d(IVEE_2012,IVEE_2017)
#Small effect size (and remember that IVEE had a VERY small sample size in 2012)

NAPL_ttest <- lob_size_NAPL %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, alternative = "less", data = ., conf.level = 0.975)
#P=0.25, retain the null

#Power analysis
NAPL_2012 <- lob_size_NAPL %>% 
 filter(YEAR == "2012") %>% 
 pull(SIZE)
 
NAPL_2017 <- lob_size_NAPL %>% 
 filter(YEAR == "2017") %>% 
 pull(SIZE)

NAPL_effsize <- cohen.d(NAPL_2012,NAPL_2017)
#Small effect size

#Step 3: Two sided, two sample t-test to compare lobster size at non-MPA sites (AQUE, MOHK, and CARP)

#HO: Lobster size does NOT significantly different between 2012 and 2017
#HA: Lobster size is significantly different between 2012 and 2017

AQUE_ttest <- lob_size_AQUE %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)
#P=0.21, retain the null

#Power analysis
AQUE_2012 <- lob_size_AQUE %>% 
 filter(YEAR == "2012") %>% 
 pull(SIZE)
 
AQUE_2017 <- lob_size_AQUE %>% 
 filter(YEAR == "2017") %>% 
 pull(SIZE)

AQUE_effsize <- cohen.d(AQUE_2012,AQUE_2017)
#Small effect size

MOHK_ttest <- lob_size_MOHK %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

#P<.001, reject the null

MOHK_2012 <- lob_size_MOHK %>% 
 filter(YEAR == "2012") %>% 
 pull(SIZE)
 
MOHK_2017 <- lob_size_MOHK %>% 
 filter(YEAR == "2017") %>% 
 pull(SIZE)

MOHK_effsize <- cohen.d(MOHK_2012,MOHK_2017)
#Medium effect size! (Cohen's d = 0.54)

CARP_ttest <- lob_size_CARP %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

#P=0.182, retain the null
CARP_2012 <- lob_size_CARP %>% 
 filter(YEAR == "2012") %>% 
 pull(SIZE)
 
CARP_2017 <- lob_size_CARP %>% 
 filter(YEAR == "2017") %>% 
 pull(SIZE)

CARP_effsize <- cohen.d(CARP_2012,CARP_2017)
#Negligible effect size

```
Mean lobster lengths at Isla Vista, an MPA site, were significantly larger in 2017 than in 2012 [t(`r IVEE_ttest$parameter`) = `r round(IVEE_ttest$statistic,2)`, *p* = `r round(IVEE_ttest$p.value,3)`, $\alpha$ = 0.025]. Despite these significant findings there is a small effect size (Cohen's d = 0.38) and number of observations between the two years were very different ($\overline{X}$ = 66.08 ± 12.09 [mm], n = 26, $\overline{X}$ = 71.45 ± 14.32 [mm], n = 606, for 2012 and 2017, respectively).

Mean lobster lengths at Mohawk Reef, a non-MPA site, differed significantly between 2012 and 2017 [t(`r MOHK_ttest$parameter`) = `r round(MOHK_ttest$statistic,2)`, *p* = `r round(MOHK_ttest$p.value,3)`, $\alpha$ = 0.05]. Furthermore, there is a medium effect size (Cohen's d = 0.54) between the mean lobster lengths at Mohawk Reef in 2012 and 2017 ($\overline{X}$ = 77.25 ± 10.59 [mm], n = 83, $\overline{X}$ = 72.00 ± 9.28 [mm], n = 178, for 2012 and 2017, respectively).

While there results show an overall increase in lobster lengths at MPA sites, the magnitude of this increase is small. However, the decrease in lobster size at Mohawk Reef, non-MPA site, in combination with the medium effect size is notable.

**Table 3. Lobster size measurements (mm) at Isla Vista and Mohawk Reef sites in 2012 to 2017.**  
Values represente mean ± standard deviation, and sample sizes are listed directly below for each site.

Part 4. Proportions of "legal" lobsters at the 5 sites in 2017

The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? 
```{r, echo = FALSE, message = FALSE}
#Propper data frame 

lob_chi <- lob_size_tidy2017 %>% 
  mutate(
    limit = case_when(SIZE > 82.6 ~ "legal", SIZE < 82.6 ~ "illegal")
  )

chi_size <- lob_chi %>%
  count(SITE, limit) %>% 
  spread(limit, n) %>% 
  select(-SITE)

rownames(chi_size) <- c("AQUE","CARP","IVEE","MOHK","NAPL")

#Actual proportions:
size_prop <- prop.table(as.matrix(chi_size), 1)
#Chi-squared 
#H0: No significant difference between proportions at the different sites

size_x2 <- chisq.test(chi_size)
```
**Table 4. Counts and proportions of lobsters below and above the legal limit, by site.**
Values indicated are counts, with proportion (by site) in italics. Lobsters above or below the legal limit differ significantly by site ($\chi^2${`r size_x2$parameter`} = 18.50, *p* = 0.001). Data source: SBC LTER)^3^.

There is a significant association between observed lobsters above or below the legal limit (82.6 mm) and location ($\chi^2${`r size_x2$parameter`} = 18.50, *p* = 0.001). Notably, lobsters above the legal limit at Naples Reef, an MPA site, (33%) was remarkably higher than those observed at Mohawk Reef, a non-MPA site (13%). 
