---
title: "Assignment 4, Lobster"
author: "Camila Bobroff, Lydia Bleifuss"
date: "11/14/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(tidyverse)
library(pwr)
library(knitr)
library(plotly)
library(extrafont)
library(ggrepel)
library(kableExtra)
library(effsize)
library(dplyr)
library(vcdExtra)
library(car)
```

```{r, include = FALSE}
lob_size_abun <- read_csv("lobster_size_abundance.csv")
lob_trap <- read_csv("lobster_traps.csv")
```

NUMBER ONE

```{r}
#Producing mean abundance by year
abun_year <- lob_size_abun %>%
  group_by(YEAR, SITE) %>% 
  filter(COUNT != "0") %>% 
  summarize(
    sum_abun = round(sum(COUNT), digits = 2)
  )
abun_year

#Producing mean trap count by year

trap_year <- lob_trap %>% 
  filter( SITE != "AHND", SITE != "ABUR", SITE != "GOLB", SITE != "AHND to AQUE") %>% 
  group_by(YEAR, SITE) %>%
  summarize(
    sum_trap = round(sum(TRAPS), digits = 2)
  )
trap_year

#Join the data sets together so they pull the same year and corresponding data 

abun_trap <- full_join(abun_year, trap_year) %>% 
  select(YEAR, SITE, sum_abun, sum_trap)

abun_trap
```

```{r}
#Creating Bubble Scatter-plot for question 1. 
abun_trap_bubble <- ggplot(abun_trap, (aes(x = YEAR,
      y = sum_trap, size = sum_abun, label = ""))) +
  geom_point(aes(color = SITE), alpha = 0.5) +
  geom_text_repel(size = 5) +
  theme_classic() +
  scale_size(range = c(0,9)) +
  geom_line(aes(color = SITE), size = 0.5)
  

abun_trap_bubble

#did not include y-expand because the dots would disappear 
```

Part 2. Compare mean lobster size by site in 2017.

```{r}

#Step 1: Get data into case/tidy format

count <- as.data.frame(lob_size_abun) #Coerce to data.frame so we can use expand.dft()
lob_size_tidy <- expand.dft(count, freq = "COUNT")#Expand data so it is in tidy format

lob_size_tidy2017 <- lob_size_tidy %>% 
  filter(YEAR == 2017) #Keep observations only from 2017

#Step 2: Calculate mean lobster sizes (carapace length (mm)) across the five sites for observations in 2017

lob_size_summary <- lob_size_tidy2017 %>% 
  group_by(SITE) %>% 
  summarize(
    mean_size2017 = mean(SIZE),
    sample_size = length(SITE)
  )
#Step 3: Test assumptions, exploratory graphs, summary statistics, Levene's test for equal variances

lobster_hists <- ggplot(lob_size_tidy2017, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE)) + 
  facet_wrap(~ SITE)

lobster_hists

lobster_qqplot <- ggplot(lob_size_tidy2017, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)

lobster_qqplot
#Data seem to be normally distributed based on our histograms and qqplots!

# Levene's test for equal variances (> 2 groups)

# H0: Variances are equal
# HA: Variances are unequal

lobster_levene <- leveneTest(SIZE ~ SITE, data = lob_size_tidy2017)
lobster_levene

# We reject the null hypothesis of equal variances (p < 0.001)...

variances <- lob_size_tidy2017 %>% 
  group_by(SITE) %>% 
  summarize(
    variance = var(SIZE)
  )

variances

# Because the largest variance is less than 4 times greater than the smallest variances, we can use an ANOVA to compare means.

#Step 4: One-way ANOVA
#Single factor: SITE | Number of levels: 5 (AQUE, CARP, IVEE, MOHK, NAPL) | Random variable: SIZE (carapace length (mm))

#QUESTION: Is there a significant difference in carapace length (mm) in AQUE, CARP, IVEE, MOHK, and NAPL?

# H0: Mean lobster carapace length across all sites are equal 
# HA: At LEAST two means differ significantly

lobster_aov <- aov(SIZE ~ SITE, data = lob_size_tidy2017)
summary(lobster_aov)

# At least two samples were taken from populations with different means (P = .009). Which ones are different?

#Step 5: Post-hoc test (Tukey's HSD)

lobster_ph <- TukeyHSD(lobster_aov)
lobster_ph
```
Mean lobster carapace length differ significantly between Naples Reef and Carpinteria and between Naples Reef and Isla Vista (F(df) = statstic, P = 0.02 & 0.004 respectively, $\alpha$ = 0.05 with post-hoc Tukey's HSD, $\alpha$ = 0.05.)
```{r}
#Step 6: Create bar graph with error bars

lob_size_graph <- lob_size_tidy2017 %>% 
  ggplot(aes(x = SITE, y = SIZE)) +
  geom_col(aes(fill = SITE), position = "dodge") +
  theme_classic()

lob_size_graph

```

Part 3. Changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)

```{r}
#Step 1: Calculate mean size at MPA and non-MPA sites for 2012 and 2017. Data exploration.

lob_size_MPA <- lob_size_tidy %>% 
  filter(SITE == "IVEE" | SITE == "NAPL") %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

MPA_summary <- lob_size_MPA %>% 
  summarize(
    mean_size = mean(SIZE)
  )

lob_size_nonMPA <- lob_size_tidy %>% 
  filter(SITE != "IVEE" | SITE != "NAPL") %>% 
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

nonMPA_summary <- lob_size_nonMPA %>% 
  summarize(
    mean_size = mean(SIZE)
  )

#Step 2: Test assumptions (MPA sites)
MPA_hists <- ggplot(lob_size_MPA, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE)) + 
  facet_wrap(~ SITE)

MPA_hists

MPA_qqplot <- ggplot(lob_size_MPA, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)

MPA_qqplot
#Based on our histograms and qqplots, our data looks normal

# F-test for equal variances
# H0: Variances are equal (ratio of variances = 1)
# HA: Variances are not equal (ratio of variances is NOT = 1)

MPA_ftest <- lob_size_MPA %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

MPA_ftest # Retain the null hypothesis of equal variances (p-value = 0.33)
# We can override the default setting in t.test() function of var.equal = FALSE

#Step 3: Two sided, two sample t-test to compare lobster size at MPA sites

#HO: Lobsters at MPA sites are NOT significantly larger in 2017 than in 2012
#HA: Lobsters at MPA sites are significantly larger in 2017 than in 2012

MPA_ttest <- lob_size_MPA %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, alternative = "less", data = .)

MPA_ttest

#Step 4: Test assumptions (non-MPA sites)
nonMPA_hists <- ggplot(lob_size_nonMPA, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE)) + 
  facet_wrap(~ SITE)

nonMPA_hists

nonMPA_qqplot <- ggplot(lob_size_nonMPA, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)

nonMPA_qqplot
#Based on our histograms and qqplots, our data looks normal

# F-test for equal variances
# H0: Variances are equal (ratio of variances = 1)
# HA: Variances are not equal (ratio of variances is NOT = 1)

nonMPA_ftest <- lob_size_nonMPA %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

nonMPA_ftest # Retain the null hypothesis of equal variances (p-value = 0.43)
# We can override the default setting in t.test() function of var.equal = FALSE

#Step 3: One sided, two sample t-test to compare lobster size at non-MPA sites

#HO: Mean lobster lengths at non-MPA sites are NOT significantly different between 2012 and 2017
#HA: Mean lobster lengths at non-MPA sites are significantly different in 2012 and 2017

nonMPA_ttest <- lob_size_nonMPA %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, alternative = "less", data = .)

nonMPA_ttest
```
Lobster lengths at MPA sites in 2017 (mean ± sd [units], n = sample size) are significantly larger than those in 2012 (mean ± sd [units], n = sample size) [t(`r MPA_ttest$parameter`) = `r round(MPA_ttest$statistic,2)`, *p* = `r round(MPA_ttest$p.value,3)`, $\alpha$ = 0.05].

Lobster lengths at non-MPA sites in 2017 (mean ± sd [units], n = sample size) do not differ significanly than those in 2012 (mean ± sd [units], n = sample size) [t(`r nonMPA_ttest$parameter`) = `r round(nonMPA_ttest$statistic,2)`, *p* = `r round(nonMPA_ttest$p.value,3)`, $\alpha$ = 0.05].

NUBMER FOUR - Chi Squared

The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? 

```{r}
#Propper data frame 

lob_chi <- lob_size_tidy2017 %>% 
  mutate(
    limit = case_when(SIZE > 82.6 ~ "greater", SIZE < 82.6 ~ "less_than")
  )

chi_size <- lob_chi %>%
  count(SITE, limit) %>% 
  spread(limit, n) %>% 
  select(-SITE)

chi_size

rownames(chi_size) <- c("AQUE","CARP","IVEE","MOHK","NAPL")

#Actual proportions:
size_prop <- prop.table(as.matrix(chi_size), 1)
size_prop

#Chi-squared 
#H0: No significant difference between proportions at the different sites

size_x2 <- chisq.test(chi_size)
size_x2
```
The proportion of observed lobsters at each site that are above the legal minimum (82.6 mm) differ significantly across the 5 sites ($\chi^2${`r size_x2$parameter`} = ....., p < 0.001). Notably, ...
