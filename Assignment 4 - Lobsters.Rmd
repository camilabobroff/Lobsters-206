---
title: "Assignment 4, Lobster"
author: "Camila Bobroff, Lydia Bleifuss"
date: "11/14/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(tidyverse)
library(pwr)
library(knitr)
library(plotly)
library(extrafont)
library(ggrepel)
library(kableExtra)
library(effsize)
library(dplyr)
library(vcdExtra)
library(car)
library(ggpubr)
```

```{r, include = FALSE}
lob_size_abun <- read_csv("lobster_size_abundance.csv")
lob_trap <- read_csv("lobster_traps.csv")
```

Part 1. Lobster abundance and fishing pressure (2012 - 2017)

```{r, echo = FALSE, message = FALSE}
#Producing mean abundance by year
abun_year <- lob_size_abun %>%
  group_by(YEAR, SITE) %>% 
  filter(COUNT != "0") %>% 
  summarize(
    sum_abun = round(sum(COUNT), digits = 2)
  ) %>% 
  rename(Site = SITE)
#Producing mean trap count by year

trap_year <- lob_trap %>% 
  filter( SITE != "AHND", SITE != "ABUR", SITE != "GOLB", SITE != "AHND to AQUE") %>% 
  group_by(YEAR, SITE) %>%
  summarize(
    sum_trap = round(sum(TRAPS), digits = 2)
  ) %>% 
  rename(Site = SITE)

#Join the data sets together so they pull the same year and corresponding data 

abun_trap <- full_join(abun_year, trap_year) %>% 
  select(YEAR, Site, sum_abun, sum_trap)
```

```{r, echo = FALSE, message = FALSE}
#Creating Scatter-plots for question 1. 

#Trap Totals
trap_point <- ggplot(abun_trap, (aes(x = YEAR,
      y = sum_trap,label = ""))) +
  geom_point(aes(color = Site)) +
  theme_classic() +
  scale_size(range = c(0,9)) +
  geom_line(aes(color = Site), size = 0.5) +
  scale_y_continuous(expand = c(0,0), limits = c(0,1300)) +
  labs(x = "Year", y = "Site Trap Totals") +
  theme(text = element_text(family = "Times New Roman")) 

trap_point

#Abundance Totals 
abun_point <- ggplot(abun_trap, (aes(x = YEAR,
      y = sum_abun,label = ""))) +
  geom_point(aes(color = Site)) +
  theme_classic() +
  scale_size(range = c(0,9)) +
  geom_line(aes(color = Site), size = 0.5) +
   scale_y_continuous(expand = c(0,0), limits = c(0,800)) +
  labs(x = "Year", y = "Total Spiny Lobster Abundance") +
  theme(text = element_text(family = "Times New Roman")) 

abun_point

```

Part 2. Compare mean lobster size by site in 2017.

```{r, echo = FALSE, message = FALSE}

#Step 1: Get data into case/tidy format

count <- as.data.frame(lob_size_abun) #Coerce to data.frame so we can use expand.dft()
lob_size_tidy <- expand.dft(count, freq = "COUNT")#Expand data so it is in tidy format

lob_size_tidy2017 <- lob_size_tidy %>% 
  filter(YEAR == 2017) %>%  #Keep observations only from 2017
  mutate(
    mean_size2017 = mean(SIZE),
    sd_size = sd(SIZE),
    sample_size = length(SITE)
  )

#Step 2: Calculate mean lobster sizes (carapace length (mm)) across the five sites for observations in 2017

lob_size_summary <- lob_size_tidy2017 %>% 
  group_by(SITE) %>% 
  summarize(
    mean_size2017 = mean(SIZE),
    sd_size = sd(SIZE),
    sample_size = length(SITE)
  )
#Step 3: Test assumptions, exploratory graphs, summary statistics, Levene's test for equal variances

lobster_hists <- ggplot(lob_size_tidy2017, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE)) + 
  facet_wrap(~ SITE)

lobster_qqplot <- ggplot(lob_size_tidy2017, aes(sample = SIZE)) +
  geom_qq() +
  facet_wrap(~ SITE)
#Data seem to be normally distributed based on our histograms and qqplots!

# Levene's test for equal variances (> 2 groups)

# H0: Variances are equal
# HA: Variances are unequal

lobster_levene <- leveneTest(SIZE ~ SITE, data = lob_size_tidy2017)
# We reject the null hypothesis of equal variances (p < 0.001)...

variances <- lob_size_tidy2017 %>% 
  group_by(SITE) %>% 
  summarize(
    variance = var(SIZE)
  )
# Because the largest variance is less than 4 times greater than the smallest variances, we can use an ANOVA to compare means.

#Step 4: One-way ANOVA
#Single factor: SITE | Number of levels: 5 (AQUE, CARP, IVEE, MOHK, NAPL) | Random variable: SIZE (carapace length (mm))

#QUESTION: Is there a significant difference in mean carapace length (mm) in AQUE, CARP, IVEE, MOHK, and NAPL?

# H0: Mean lobster carapace length across all sites are equal 
# HA: At LEAST two means differ significantly

lobster_aov <- aov(SIZE ~ SITE, data = lob_size_tidy2017)
# At least two samples were taken from populations with different means (P = .009). Which ones are different?

#Step 5: Post-hoc test (Tukey's HSD)

lobster_ph <- TukeyHSD(lobster_aov)
lobster_ph
```
Mean lobster carapace length differ significantly between Naples Reef and Carpinteria and between Naples Reef and Isla Vista (F(df) = statstic, P = 0.02 & 0.004 respectively, $\alpha$ = 0.05 with post-hoc Tukey's HSD, $\alpha$ = 0.05.)
```{r, echo = FALSE, message = FALSE}
#Step 6: Create column graph with error bars indicating ±1 standard deviation

# Global test
compare_means(SIZE ~ SITE,  data = lob_size_tidy, method = "anova")

lob_boxplot <- ggplot(lob_size_tidy2017, aes(x = SITE, y = SIZE))+
  geom_boxplot(aes(fill = SITE, colour = SITE), alpha = 0.5, show.legend = FALSE)+
  labs(title="Mean Lobster Sizes by Location in 2017", 
                    x ="Location",
                    y = "Mean Carapace Length (mm)")+
  theme_classic()+
  theme(legend.position = "none")+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+
  stat_compare_means(method = "anova", label.y = 170)+ # Add global p-value
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "0.5") # Pairwise comparison against

lob_boxplot
```

Part 3. Changes in lobster size at MPA and non-MPA sites (comparing only 2012 and 2017 sizes)

```{r, echo = FALSE, message = FALSE}
#Step 1: Calculate mean size at each MPA and non-MPA site for 2012 and 2017. Data exploration.

lob_size_IVEE <- lob_size_tidy %>% 
  filter(SITE == "IVEE") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

IVEE_summary <- lob_size_IVEE %>% 
  summarize(
    mean_size = mean(SIZE)
  )

lob_size_NAPL <- lob_size_tidy %>% 
  filter(SITE == "NAPL") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

NAPL_summary <- lob_size_NAPL %>% 
  summarize(
    mean_size = mean(SIZE)
  )

lob_size_AQUE <- lob_size_tidy %>% 
  filter(SITE == "AQUE") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

AQUE_summary <- lob_size_AQUE %>% 
  summarize(
    mean_size = mean(SIZE)
  )

lob_size_MOHK <- lob_size_tidy %>% 
  filter(SITE == "MOHK") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

MOHK_summary <- lob_size_MOHK %>% 
  summarize(
    mean_size = mean(SIZE)
  )

lob_size_CARP <- lob_size_tidy %>% 
  filter(SITE == "CARP") %>%  
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  group_by(YEAR)

CARP_summary <- lob_size_CARP %>% 
  summarize(
    mean_size = mean(SIZE)
  )

#Step 2: Test assumptions (each site)
hists <- ggplot(lob_size_tidy, aes(x = SIZE))+
  geom_histogram(aes(fill = SITE))+
  facet_wrap(~SITE)

qqplots <- ggplot(lob_size_tidy, aes(sample = SIZE)) +
  geom_qq()+
  facet_wrap(~SITE)

#Based on our histograms and qqplots, our data looks normal

# F-test for equal variances
# H0: Variances are equal (ratio of variances = 1)
# HA: Variances are not equal (ratio of variances is NOT = 1)

IVEE_ftest <- lob_size_IVEE %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

IVEE_ftest # Retain the null hypothesis of equal variances (p-value = 0.30)
# We can override the default setting in t.test() function of var.equal = FALSE

NAPL_ftest <- lob_size_NAPL %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.76)
# We can override the default setting in t.test() function of var.equal = FALSE

AQUE_ftest <- lob_size_AQUE %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.30)
# We can override the default setting in t.test() function of var.equal = FALSE

MOHK_ftest <- lob_size_MOHK %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.15)
# We can override the default setting in t.test() function of var.equal = FALSE

CARP_ftest <- lob_size_CARP %>% 
  var.test(SIZE ~ YEAR, data = .) # data = . is saying to access the most recent datafarme used

# Retain the null hypothesis of equal variances (p-value = 0.20)
# We can override the default setting in t.test() function of var.equal = FALSE

#Step 3: One sided, two sample t-test to compare lobster size at MPA sites (IVEE and NAPL)

#HO: Lobsters are NOT significantly larger in 2017 than in 2012
#HA: Lobsters are significantly larger in 2017 than in 2012

IVEE_ttest <- lob_size_IVEE %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, alternative = "less", data = .)

NAPL_ttest <- lob_size_NAPL %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, alternative = "less", data = .)

#Step 3: Two sided, two sample t-test to compare lobster size at non-MPA sites (AQUE, MOHK, and CARP)

#HO: Lobster size does NOT significantly different between 2012 and 2017
#HA: Lobster size is significantly different between 2012 and 2017

AQUE_ttest <- lob_size_AQUE %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

MOHK_ttest <- lob_size_MOHK %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)

CARP_ttest <- lob_size_CARP %>%
  t.test(SIZE ~ YEAR, var.equal = TRUE, data = .)
```
Mean lobster lengths in Isla Vista (mean ± sd [units], n = sample size) and Mohawk Reef (mean ± sd [units], n = sample size) differ signifcantly in 2012 and 2017 [t(`r IVEE_ttest$parameter`) = `r round(IVEE_ttest$statistic,2)`, *p* = `r round(IVEE_ttest$p.value,3)`, $\alpha$ = 0.05], t(`r MOHK_ttest$parameter`) = `r round(MOHK_ttest$statistic,2)`, *p* = `r round(MOHK_ttest$p.value,3)`, $\alpha$ = 0.05, respectively]). Notably, lobster length in 2017 was larger in 2017 than in 2012 for Isla Vista, an MPA site, and smaller for Mohawk Reef, a non-MPA site.

Part 4. Proportions of "legal" lobsters at the 5 sites in 2017

The legal minimum carapace size for lobster is 82.6 mm. What proportion of observed lobsters at each site are above the legal minimum? Does that proportion differ significantly across the 5 sites? 
```{r, echo = FALSE, message = FALSE}
#Propper data frame 

lob_chi <- lob_size_tidy2017 %>% 
  mutate(
    limit = case_when(SIZE > 82.6 ~ "greater", SIZE < 82.6 ~ "less_than")
  )

chi_size <- lob_chi %>%
  count(SITE, limit) %>% 
  spread(limit, n) %>% 
  select(-SITE)

rownames(chi_size) <- c("AQUE","CARP","IVEE","MOHK","NAPL")

#Actual proportions:
size_prop <- prop.table(as.matrix(chi_size), 1)

#Chi-squared 
#H0: No significant difference between proportions at the different sites

size_x2 <- chisq.test(chi_size)
```
The proportion of observed lobsters at each site that are above the legal minimum (82.6 mm) differ significantly across the 5 sites ($\chi^2${`r size_x2$parameter`} = ....., p < 0.001). Notably, ...
